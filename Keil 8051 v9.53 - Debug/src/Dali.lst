C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE DALI
OBJECT MODULE PLACED IN .\src\Dali.OBJ
COMPILER INVOKED BY: c:\SiliconLabs\SimplicityStudio\v3\developer\toolchains\keil_8051\9.53\BIN\C51.exe C:\Users\clfilho
                    -\Dropbox (Silicon Labs)\Code_Workspace\EFM8UB1_Timer0_8bitReload\src\Dali.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WAR
                    -NINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:\Users\clfilho\Dropbo
                    -x (Silicon Labs)\Code_Workspace\EFM8UB1_Timer0_8bitReload\inc;C:/SiliconLabs/SimplicityStudio/v3/developer/sdks/si8051/v
                    -3//Device/shared/si8051Base;C:/SiliconLabs/SimplicityStudio/v3/developer/sdks/si8051/v3//Device/EFM8UB1;C:/SiliconLabs/S
                    -implicityStudio/v3/developer/sdks/si8051/v3//Device/EFM8UB1/inc) PRINT(.\src\Dali.lst) COND PAGEWIDTH(120) PAGELENGTH(65
                    -) OBJECT(.\src\Dali.OBJ)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // Dali.c
   3          //-----------------------------------------------------------------------------
   4          // Copyright 2014 Silicon Laboratories, Inc.
   5          // http://developer.silabs.com/legal/version/v11/Silicon_Labs_Software_License_Agreement.txt
   6          //
   7          // Program Description:
   8          //
   9          // This program uses Timer0 in 8-bit counter/timer with reload mode.
  10          // It uses the Timer0 to create an interrupt at a certain rate and toggles
  11          // the LED when the interrupt counter reaches the selected value. 
  12          //
  13          // Resources:
  14          //   SYSCLK - 24.5 MHz HFOSC0 / 8
  15          //   Timer0 - 10 Hz interrupt
  16          //   P1.4   - LED green
  17          //   P2.3   - Display enable
  18          //
  19          //-----------------------------------------------------------------------------
  20          // How To Test: EFM8UB1 STK
  21          //-----------------------------------------------------------------------------
  22          // 1) Place the switch in "AEM" mode.
  23          // 2) Connect the EFM8UB1 STK board to a PC using a mini USB cable.
  24          // 3) Compile and download code to the EFM8UB1 STK board.
  25          //    In Simplicity Studio IDE, select Run -> Debug from the menu bar,
  26          //    click the Debug button in the quick menu, or press F11.
  27          // 4) Run the code.
  28          //    In Simplicity Studio IDE, select Run -> Resume from the menu bar,
  29          //    click the Resume button in the quick menu, or press F8.
  30          // 5) Check that the green LED is blinking.
  31          //
  32          // Target:         EFM8UB1
  33          // Tool chain:     Generic
  34          //
  35          // Release 0.1 (ST)
  36          //    - Initial Revision
  37          //    - 10 OCT 2014
  38          //
  39          
  40          //-----------------------------------------------------------------------------
  41          // Includes
  42          //-----------------------------------------------------------------------------
  43          #include <SI_EFM8UB1_Register_Enums.h>
  44          #include "InitDevice.h"
  45          #include "Dali.h"
  46          
  47          
  48          
  49          
  50          bit MDone;
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 2   

  51          bit MOutput;
  52          bit DaliStopFlag;
  53          
  54          
  55          
  56          /*********************************************************************************
  57           *********************************************************************************
  58                                                   Manchester Encoder Related Functions
  59           *********************************************************************************
  60           *********************************************************************************/
  61          
  62          
  63          /*Manchester Decoder Busy Flag Getters and Setters*/
  64          
  65          void SetBusyFlag()
  66          {
  67   1              MDone=1;
  68   1      }
  69          
  70          void ClearBusyFlag()
  71          {
  72   1              MDone=0;
  73   1      }
  74          
  75          bit GetBusyFlag()
  76          {
  77   1       return MDone;
  78   1      }
  79          
  80          /*Manchester Decoder Output Flag Getters and Setters*/
  81          
  82          void SetMDOutput()
  83          {
  84   1              MOutput =1;
  85   1      }
  86          
  87          void ClearMDOutput()
  88          {
  89   1              MOutput =0;
  90   1      }
  91          
  92          bit GetMDOutput()
  93          {
  94   1       return MOutput;
  95   1      }
  96          SI_SBIT (LED2,SFR_P1, 4);                          //PB0 Switch Definition
  97          
  98          void ManchesterEncoder (uint8_t input)
  99          {
 100   1              static BITS_BYTE Input;
 101   1      
 102   1              static int8_t counter = 8;
 103   1      
 104   1              ClearBusyFlag();
 105   1      
 106   1              if (counter==8)
 107   1              {
 108   2                      Input.Abyte = input;
 109   2              }
 110   1      
 111   1              while (counter>=0)
 112   1              {
 113   2                      while(GetBusyFlag()==1);
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 3   

 114   2      
 115   2                      if (GetBusyFlag()==0)
 116   2                      {
 117   3                              switch (counter--){
 118   4      
 119   4                                                              case 0: //SetBusyFlag();
 120   4                                                              break;
 121   4                                                              case 1: MOutput = Input.nybble.BB0;
 122   4                                                              SetBusyFlag();
 123   4                                                              break;
 124   4                                                              case 2: MOutput = Input.nybble.BB1;
 125   4                                                              SetBusyFlag();
 126   4                                                              break;
 127   4                                                              case 3: MOutput = Input.nybble.BB2;
 128   4                                                              SetBusyFlag();
 129   4                                                              break;
 130   4                                                              case 4: MOutput = Input.nybble.BB3;
 131   4                                                              SetBusyFlag();
 132   4                                                              break;
 133   4                                                              case 5: MOutput = Input.nybble.BB4;
 134   4                                                              SetBusyFlag();
 135   4                                                              break;
 136   4                                                              case 6: MOutput = Input.nybble.BB5;
 137   4                                                              SetBusyFlag();
 138   4                                                              break;
 139   4                                                              case 7: MOutput = Input.nybble.BB6;
 140   4                                                              SetBusyFlag();
 141   4                                                              break;
 142   4                                                              case 8: MOutput = Input.nybble.BB7;
 143   4                                                              SetBusyFlag();
 144   4                                                              break;
 145   4                                      }
 146   3      
 147   3                              //if (counter-->=1)     SetBusyFlag();
 148   3      
 149   3                      }
 150   2      
 151   2              }
 152   1      
 153   1              counter=8;
 154   1      
 155   1      }
 156          
 157          
 158          
 159          void DaliTxHandler()
 160          {
 161   1              static uint8_t counter = 0;
 162   1              static uint8_t evcounter = 0;
 163   1      
 164   1              if (GetBusyFlag())
 165   1              {
 166   2                      if (evcounter++==15)
 167   2                              {evcounter=0;}
 168   2                      if (GetDaliStopFlag()==0)               //Are these the Stop Bits?
 169   2                      {
 170   3      
 171   3                              //The next lines implement the two steps of the Manchester Decoding
 172   3                              if (counter==0)                                 //Process First Part of the Byte
 173   3                              {
 174   4                                      if (GetMDOutput()==0) SetDaliOutputPin();
 175   4                                      else ClearDaliOutputPin();
 176   4                                      counter++;
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 4   

 177   4                              }
 178   3                              else
 179   3                              {                                                               //Process 2nd Part of the Byte
 180   4      
 181   4                                      if (GetMDOutput()==0) ClearDaliOutputPin();
 182   4                                      else SetDaliOutputPin();
 183   4                                      counter=0;
 184   4      
 185   4                                      ClearBusyFlag();                //Finished Processing Byte for Manchester Encoder
 186   4                              }
 187   3      
 188   3                      }
 189   2                      else                            //Yes, This is the Stop bits stage
 190   2                              {
 191   3                                      if (counter++<4)        SetDaliOutputPin();             //It keeps the Output High for 4 Cycles of the Timer
 192   3                                      else{
 193   4                                                      SetDaliOutputPin();             //The Line is normally High;
 194   4                                                      counter=0;
 195   4                                                      ClearDaliStopFlag();
 196   4                                                      ClearBusyFlag();                //Finished Processing Byte for Manchester Encoder
 197   4                                              }
 198   3                              }
 199   2                      }
 200   1      
 201   1      }
 202          /*********************************************************************************
 203           *********************************************************************************
 204                                                   Dali TX Related Functions
 205           *********************************************************************************
 206           *********************************************************************************/
 207          
 208          
 209          void ReloadDaliTxTimer(uint8_t reloadH, uint8_t reloadL)
 210          {
 211   1              TH0 = reloadH;
 212   1              TL0 = reloadL;
 213   1      }
 214          
 215          
 216          void StartDaliTxTimer()
 217          {
 218   1      
 219   1              TCON |= TCON_TR0__RUN;          //Enables Timer 1 Run
 220   1      }
 221          
 222          
 223          uint16_t GetDaliTxTimer()
 224          {
 225   1              return TH0|TL0;
 226   1      }
 227          
 228          
 229          void StopDaliTxTimer()
 230          {
 231   1      
 232   1              TH1 = 0;
 233   1              TL1 = 0;
 234   1              TCON |= TCON_TR0__STOP;         //Enables Timer 1 Run
 235   1      }
 236          
 237          
 238          void DaliFrameStart()
 239          {
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 5   

 240   1              ClearBusyFlag();                                //Clear Flag that indicates the Manchester Decoder is Busy on the Interrupt
 241   1              SetMDOutput();
 242   1              SetBusyFlag();                                  //Sets the Busy Flag so the Bit can be processed
 243   1              while(GetBusyFlag()==1);                //Waits until the Bit gets transmitted
 244   1      
 245   1      }
 246          
 247          void DaliFrameStop()
 248          {
 249   1              ClearBusyFlag();                //Clear Flag that indicates the Manchester Decoder is Busy on the Interrupt
 250   1              SetDaliStopFlag();
 251   1              SetBusyFlag();                  //Sets the Busy Flag so the Bit can be processed
 252   1              while(GetBusyFlag()==1);                //Waits until the Bit gets transmitted
 253   1      
 254   1      }
 255          
 256          void DaliTXStateMachine(uint8_t address, uint8_t Ddata)
 257          {
 258   1              DALI_TXFRAME States;
 259   1      
 260   1              SetDaliOutputPin();                     //The Line is Normally High
 261   1              States = START;
 262   1      
 263   1              while (States<END)
 264   1              {
 265   2                      switch (States)
 266   2                      {
 267   3                              case START: {
 268   4                                                              DaliFrameStart();
 269   4                                                              States= ADDRESS;
 270   4                                                              break;
 271   4                                                      }
 272   3      
 273   3                              case ADDRESS: {
 274   4                                                              ManchesterEncoder(address);
 275   4                                                              States= DATA;
 276   4                                                              break;
 277   4                                                      }
 278   3      
 279   3                              case DATA: {
 280   4                                                              ManchesterEncoder(Ddata);
 281   4                                                              States= STOP;
 282   4                                                              break;
 283   4                                                      }
 284   3      
 285   3                              case STOP: {
 286   4                                                              DaliFrameStop();
 287   4                                                              States= END;
 288   4                                                              break;
 289   4                                                      }
 290   3      
 291   3                      }
 292   2              }
 293   1      
 294   1      }
 295          /*Dali Stop bit Flag Getters and Setters*/
 296          
 297          void SetDaliStopFlag()
 298          {
 299   1              DaliStopFlag =1;
 300   1      }
 301          
 302          void ClearDaliStopFlag()
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 6   

 303          {
 304   1              DaliStopFlag =0;
 305   1      }
 306          
 307          bit GetDaliStopFlag()
 308          {
 309   1       return DaliStopFlag;
 310   1      }
 311          
 312          
 313          void SetDaliOutputPin()
 314          {
 315   1              DALI_OUT=1;
 316   1      }
 317          
 318          void ClearDaliOutputPin()
 319          {
 320   1              DALI_OUT=0;
 321   1      }
 322          
 323          bit GetDaliOutputPin()
 324          {
 325   1       return DALI_OUT;
 326   1      }
 327          
 328          
 329          /*********************************************************************************
 330           *********************************************************************************
 331                                                   Dali RX Related Functions
 332           *********************************************************************************
 333           *********************************************************************************/
 334          uint8_t BusQuietCounter;
 335          
 336          bit GetDaliIntputPin()
 337          {
 338   1       return DALI_IN;
 339   1      }
 340          
 341          void EnableDaliRxTimerInt()
 342          {
 343   1              IE |= IE_ET1__ENABLED;
 344   1      }
 345          
 346          void DisableDaliRxTimerInt()
 347          {
 348   1              IE &= 0xf7;
 349   1      }
 350          
 351          
 352          void ReloadDaliRxTimer(uint8_t reloadH, uint8_t reloadL)
 353          {
 354   1              TH1 = reloadH;
 355   1              TL1 = reloadL;
 356   1      }
 357          
 358          void StartDaliRxTimer()
 359          {
 360   1      
 361   1              TH1 = 0;
 362   1              TL1 = 0;
 363   1              TCON |= TCON_TR1__RUN;          //Enables Timer 1 Run
 364   1      }
 365          
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 7   

 366          
 367          uint16_t GetDaliRxTimer()
 368          {
 369   1              return TH1|TL1;
 370   1      }
 371          
 372          
 373          void StopDaliRxTimer()
 374          {
 375   1      
 376   1              TH1 = 0;
 377   1              TL1 = 0;
 378   1              TCON |= TCON_TR1__STOP;         //Enables Timer 1 Run
 379   1      }
 380          
 381          void QueryDaliBus()
 382          {
 383   1              static counter=0;
 384   1      
 385   1              if ((GetDaliIntputPin()==1) && (counter++==3))
 386   1              {
 387   2                      counter=0;
 388   2                      if(GetBusQuietCounter()<=254) IncBusQuietCounter();
 389   2              }
 390   1              if (GetDaliIntputPin()==0)
 391   1              {
 392   2                      counter=0;
 393   2                      ClearBusQuietCounter();
 394   2              }
 395   1      }
 396          
 397          
 398          void IncBusQuietCounter()
 399          {
 400   1              BusQuietCounter++;
 401   1      }
 402          
 403          void ClearBusQuietCounter()
 404          {
 405   1              BusQuietCounter=0;
 406   1      }
 407          
 408          uint8_t GetBusQuietCounter()
 409          {
 410   1              return BusQuietCounter;
 411   1      }
 412          
 413          
 414          void SetDaliInputPinPolarity (INTPOLARITY input)
 415          {
 416   1              if (input==ACTIVE_HIGH) IT01CF |= 0x80;
 417   1              else IT01CF &=0x7f;
 418   1      }
 419          
 420          
 421          void EnableInt1 ()
 422          {
 423   1              IE |= 0x4;
 424   1      }
 425          
 426          void DisableInt1 ()
 427          {
 428   1              IE &= 0xfb;
C51 COMPILER V9.53.0.0   DALI                                                              03/07/2016 12:35:21 PAGE 8   

 429   1      }
 430          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    515    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
